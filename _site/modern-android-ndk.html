<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>최신 안드로이드 NDK 튜토리얼 : Burt.K</title>

    <link href='https://fonts.googleapis.com/css?family=Lato:300italic,700italic,300,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <script src="/assets/js/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header >
        <h1><a href="/archive">Burt.K</a></h1>
        
          <p>코코아를 좋아하는 프로그래머입니다 ;)</p>
        

        <ul>
          <li><a href="/about"><strong>소개</strong></a></li>
          <li><a href="/archive"><strong>아카이브</strong></a></li>
          <li><a href="/opensources"><strong>오픈소스</strong></a></li>
          <li><a href="/books"><strong>책모음</strong></a></li>
        </ul>    

      </header>
      <section>


		<h1 class="entry-title">
		
		    <a href="/modern-android-ndk">최신 안드로이드 NDK 튜토리얼</a>
		
		
		</h1>
		
      <p><code class="highlighter-rouge">[출처]</code> : <a href="https://medium.com/@jrejaud/modern-android-ndk-tutorial-630bc11829a2">https://medium.com/@jrejaud/modern-android-ndk-tutorial-630bc11829a2</a></p>

<p>이 글에서는 Android Studio2.2이상에서 Android NDK를 사용하여 C 또는 C++ 코드를 사용하는 기본 내용을 다룹니다. 제가 NDK를 시작했을 때 어려움을 겪었기에 다양한 곳에서 배운 정보들을 이 글 하나로 요약했습니다.(접근 가능한 정보들은 글 하단에 링크로 적어 두었습니다.)</p>

<p>이 글은 C 보다는 C++에 좀 더 중점을 두어 작성했습니다.</p>

<ul>
  <li>시작하기(NDK 개발환경 구성하기)</li>
  <li>자바에서 호출 할 수 있는 네이티브 메서드 만들기</li>
  <li>자바 객체를 자바와 네이티브 코드간에 주고 받기</li>
  <li>자바 객체 배열을 자바와 네이티브 코드간에 주고 받기</li>
</ul>

<p>Android Studio2.2이상은 예저에 쓰이던 ndk-build 대신에 CMake 빌드 스크립트를 사용합니다. NDK를 공부하다가 막히면 <a href="https://github.com/googlesamples/android-ndk">구글의 NDK 샘플 코드</a>를 참고하시길 바랍니다.</p>

<h2 id="시작하기">시작하기</h2>

<p>먼저 구글에서 제공하는 <code class="highlighter-rouge">NDK 시작하기</code>문서 일독을 추천합니다.</p>

<ul>
  <li><a href="https://developer.android.com/ndk/guides/index.html">https://developer.android.com/ndk/guides/index.html</a></li>
</ul>

<p>구글 가이드는 안드로이드 NDK를 사용하는데 필요한 핵심 정보를 제공합니다.</p>

<h3 id="c-또는-c-소스파일을-프로젝트에-추가하기">C 또는 C++ 소스파일을 프로젝트에 추가하기</h3>

<ul>
  <li><a href="https://developer.android.com/studio/projects/add-native-code.html#create-sources">https://developer.android.com/studio/projects/add-native-code.html#create-sources</a></li>
</ul>

<h3 id="cmake-빌드-스크립트-만들기">CMake 빌드 스크립트 만들기</h3>

<ul>
  <li><a href="https://developer.android.com/studio/projects/add-native-code.html#create-cmake-script">https://developer.android.com/studio/projects/add-native-code.html#create-cmake-script</a></li>
</ul>

<p>다음은 CMakeLists 파일 예제입니다. 작성한 코드에서는 Myfile.cpp인 C++파일과 자바 코드를 연결하려고 합니다.</p>

<div class="language-cmake highlighter-rouge"><pre class="highlight"><code><span class="c1"># Sets the minimum version of CMake required to build your native library.</span>
<span class="c1"># This ensures that a certain set of CMake features is available to</span>
<span class="c1"># your build.</span>

<span class="nb">cmake_minimum_required</span><span class="p">(</span>VERSION 3.4.1<span class="p">)</span>

<span class="c1"># Specifies a library name, specifies whether the library is STATIC or</span>
<span class="c1"># SHARED, and provides relative paths to the source code. You can</span>
<span class="c1"># define multiple libraries by adding multiple add.library() commands,</span>
<span class="c1"># and CMake builds them for you. When you build your app, Gradle</span>
<span class="c1"># automatically packages shared libraries with your APK.</span>

<span class="nb">add_library</span><span class="p">(</span> <span class="c1"># Specifies the name of the library.</span>
             Myfile

             <span class="c1"># Sets the library as a shared library.</span>
             SHARED

             <span class="c1"># Provides a relative path to your source file(s).</span>
             src/main/cpp/Myfile.cpp <span class="p">)</span>

<span class="c1"># Add the directories where the Cpp header files are to let CMake find them during compile time</span>
<span class="nb">include_directories</span><span class="p">(</span>src/main/cpp/<span class="p">)</span>
</code></pre>
</div>

<p>Myfile.cpp에서는 <a href="http://glm.g-truc.net/0.9.8/index.html">OpenGL 수학</a>과 관련된 라이브러리를 사용하고 있습니다. 필요한 glm 파일들을 다운로드합니다. 받은 glm파일들을 <code class="highlighter-rouge">src/main/cpp/glm</code>으로 복사합니다. 그리고 <code class="highlighter-rouge">include_directories(src/main/cpp/)</code>로 glm라이브러리를 포함해야 한다고 알려줍니다.</p>

<h3 id="gradle에-네이티브-라이브러리-연결하기">Gradle에 네이티브 라이브러리 연결하기</h3>

<ul>
  <li><a href="https://developer.android.com/studio/projects/add-native-code.html#link-gradle">https://developer.android.com/studio/projects/add-native-code.html#link-gradle</a></li>
</ul>

<p>CMake 파일에 옵션 인자와 플래그를 지정할 수 있습니다. 예를 들어, Myfile.cpp는 C++11을 필요로 하며 예외를 허용해야할 때 아래처럼 Gradle에 작성해 줍니다.</p>

<div class="language-gradle highlighter-rouge"><pre class="highlight"><code><span class="n">externalNativeBuild</span> <span class="o">{</span>
    <span class="n">cmake</span> <span class="o">{</span>
        <span class="c1">// Required by MyFile.cpp</span>
        <span class="n">cppFlags</span> <span class="s2">"-std=c++11"</span> <span class="c1">//Enable C++ 11</span>
        <span class="n">cppFlags</span> <span class="s2">"-fexceptions"</span> <span class="c1">//Allow exceptions</span>
    <span class="o">}</span>
</code></pre>
</div>

<h2 id="자바와-네이티브-코드간에-통신하기">자바와 네이티브 코드간에 통신하기</h2>

<p>지금까지 C/C++ 네이티브 코드를 가져와 NDK를 설정했습니다. 그리고 Gradle을 통해 안드로이드 프로젝트에 연결했습니다. 다음은 자바와 네이티브 코드간에 서로 통신할 수 있도록 해줘야 합니다.</p>

<h3 id="자바에서는">자바에서는</h3>

<p>개인적으로 정적으로 네이티브 라이브러리를 로드하고 호출하며, 네이티브 메서드만을 선언해 놓은 자바 클래스를 만드는 것이 좋다고 생각합니다.</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="c1">// Wrapper for native library </span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">NativeLib</span> <span class="o">{</span>      
    
    <span class="kd">static</span> <span class="o">{</span>
        <span class="c1">// Replace "Myfile" with the name of your Native File</span>
        <span class="n">System</span><span class="o">.</span><span class="na">loadLibrary</span><span class="o">(</span><span class="s">"Myfile"</span><span class="o">);</span>     
    <span class="o">}</span>
    
    <span class="c1">// Declare your native methods here     </span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">native</span> <span class="n">String</span> <span class="nf">string</span><span class="o">();</span>
<span class="o">}</span>
</code></pre>
</div>

<p><code class="highlighter-rouge">System.loadLibrary("Myfile");</code>을 사용해 <code class="highlighter-rouge">Myfile</code>을 로드합니다.</p>

<h3 id="네이티브에서는">네이티브에서는</h3>

<h4 id="1-자바에서-호출할-수-있는-네이티브-메서드-만들기">1. 자바에서 호출할 수 있는 네이티브 메서드 만들기</h4>

<p>자바 코드에서 다이렉트로 네이티브 메서드를 호출할 수 없습니다. 대신 특정한 방법으로 자바 코드에서 네이티브 메서드가 호출되도록 추가 구현이 필요합니다.</p>

<div class="language-cpp highlighter-rouge"><pre class="highlight"><code><span class="c1">//You need this to allow methods that can be invoked by Java
</span><span class="cp">#include &lt;jni.h&gt;
</span>
<span class="c1">//This syntax is needed if you are invoking a C++ method. C methods are slightly different
</span>
<span class="c1">//Since the String method returns a String object, specify jstring. Replace this with whatever return object your method has.
</span>
<span class="k">extern</span> <span class="s">"C"</span> <span class="n">JNIEXPORT</span> <span class="n">jstring</span> <span class="n">JNICALL</span>
<span class="c1">//Replace the crazy ass method name with the path to the Java file that is invoking it (com/example/NativeLib in this case).
</span>
<span class="c1">//The Native Methods must always have JNIEnv *env, jobject object as the first two parameters
</span><span class="n">Java_com_example_NativeLib_string</span><span class="p">(</span><span class="n">JNIEnv</span> <span class="o">*</span><span class="n">env</span><span class="p">,</span> <span class="n">jobject</span> <span class="n">object</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//This is how you return a jstring via C++ code
</span>    <span class="k">return</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">NewStringUTF</span><span class="p">(</span><span class="s">"Hello from JNI LIBS!"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre>
</div>

<h5 id="c문법-vs-c문법">C문법 vs C++문법</h5>

<p><code class="highlighter-rouge">출처</code>: <a href="http://adndevblog.typepad.com/cloud_and_mobile/2013/08/android-ndk-passing-complex-data-to-jni.html">Original Post by Philippe Leefsma</a></p>

<div class="language-cpp highlighter-rouge"><pre class="highlight"><code><span class="c1">// C syntax: my package name is com.autodesk.and.jnitester
// and my activity invoking the native method is MainActivity,
// hence the name of my method is
//Java_com_autodesk_and_jnitester_MainActivity_MethodName
</span><span class="n">JNIEXPORT</span>
<span class="n">jstring</span>
<span class="n">JNICALL</span>
<span class="nf">Java_com_autodesk_adn_jnitester_MainActivity_getMessageFromNative</span><span class="p">(</span>
    <span class="n">JNIEnv</span> <span class="o">*</span><span class="n">env</span><span class="p">,</span>
    <span class="n">jobject</span> <span class="n">callingObject</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="o">*</span><span class="n">env</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">NewStringUTF</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="s">"Native code rules!"</span><span class="p">);</span>
<span class="p">}</span>


<span class="c1">// C++ syntax: Required to declare as extern "C" to prevent c++ compiler
// to mangle function names
</span><span class="k">extern</span> <span class="s">"C"</span>
<span class="p">{</span>
     <span class="n">JNIEXPORT</span>
     <span class="n">jstring</span>
     <span class="n">JNICALL</span>
     <span class="n">Java_com_autodesk_adn_jnitester_MainActivity_getMessageFromNative</span><span class="p">(</span>
                <span class="n">JNIEnv</span> <span class="o">*</span><span class="n">env</span><span class="p">,</span>
                <span class="n">jobject</span> <span class="n">callingObject</span><span class="p">)</span>
     <span class="p">{</span>
           <span class="k">return</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">NewStringUTF</span><span class="p">(</span><span class="s">"Native code rules!"</span><span class="p">);</span>
     <span class="p">}</span>
<span class="p">};</span>
</code></pre>
</div>

<h4 id="2-자바와-네이티브-코드-간에-객체-주고-받기">2. 자바와 네이티브 코드 간에 객체 주고 받기</h4>

<p><code class="highlighter-rouge">출처</code>: <a href="http://adndevblog.typepad.com/cloud_and_mobile/2013/08/android-ndk-passing-complex-data-to-jni.html">Original Post by Philippe Leefsma</a></p>

<h5 id="먼저-자바쪽에-간단한-pojo를-정의합니다">먼저, 자바쪽에 간단한 POJO를 정의합니다.</h5>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MeshData</span>
<span class="o">{</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">_facetCount</span><span class="o">;</span>
   
    <span class="kd">public</span> <span class="kt">float</span><span class="o">[]</span> <span class="n">VertexCoords</span><span class="o">;</span>
 
    <span class="kd">public</span> <span class="nf">MeshData</span><span class="o">(</span><span class="kt">int</span> <span class="n">facetCount</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="n">_facetCount</span> <span class="o">=</span> <span class="n">facetCount</span><span class="o">;</span>
       
        <span class="n">VertexCoords</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">float</span><span class="o">[</span><span class="n">facetCount</span><span class="o">];</span>
       
        <span class="c1">// fills up coords with dummy values</span>
        <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">facetCount</span><span class="o">;</span> <span class="o">++</span><span class="n">i</span><span class="o">)</span>
        <span class="o">{</span>
           <span class="n">VertexCoords</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="mf">10.0f</span> <span class="o">*</span> <span class="n">i</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
 
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getFacetCount</span><span class="o">()</span>
    <span class="o">{</span>
        <span class="k">return</span> <span class="n">_facetCount</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<h5 id="만든-pojo객체를-네이티브-코드로-전달하는-자바-메서드를-작성합니다">만든 POJO객체를 네이티브 코드로 전달하는 자바 메서드를 작성합니다.</h5>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">native</span> <span class="kt">float</span> <span class="nf">getMemberFieldFromNative</span><span class="o">(</span><span class="n">MeshData</span> <span class="n">obj</span><span class="o">);</span>
</code></pre>
</div>

<h5 id="네이티브-코드에서-전달된-자바-객체의-필드를-읽습니다">네이티브 코드에서 전달된 자바 객체의 필드를 읽습니다.</h5>

<div class="language-cpp highlighter-rouge"><pre class="highlight"><code><span class="n">JNIEXPORT</span>
<span class="n">jfloat</span>
<span class="n">JNICALL</span>
<span class="nf">Java_com_autodesk_adn_jnitester_MainActivity_getMemberFieldFromNative</span>
<span class="p">(</span>
	<span class="n">JNIEnv</span> <span class="o">*</span><span class="n">env</span><span class="p">,</span>
	<span class="n">jobject</span> <span class="n">callingObject</span><span class="p">,</span>
	<span class="n">jobject</span> <span class="n">obj</span> <span class="c1">//obj is the MeshData java object passed
</span><span class="p">)</span> 
<span class="p">{</span>
   <span class="kt">float</span> <span class="n">result</span> <span class="o">=</span> <span class="mf">0.0</span><span class="n">f</span><span class="p">;</span>
 
   <span class="c1">//Get the passed object's class  
</span>   <span class="n">jclass</span> <span class="n">cls</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetObjectClass</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
 
   <span class="c1">// get field [F = Array of float
</span>   <span class="n">jfieldID</span> <span class="n">fieldId</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetFieldID</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="s">"VertexCoords"</span><span class="p">,</span> <span class="s">"[F"</span><span class="p">);</span>
 
   <span class="c1">// Get the object field, returns JObject (because it’s an Array)
</span>   <span class="n">jobject</span> <span class="n">objArray</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetObjectField</span> <span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">fieldId</span><span class="p">);</span>
 
   <span class="c1">// Cast it to a jfloatarray
</span>   <span class="n">jfloatArray</span><span class="o">*</span> <span class="n">fArray</span> <span class="o">=</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">jfloatArray</span><span class="o">*&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">objArray</span><span class="p">);</span>
 
   <span class="n">jsize</span> <span class="n">len</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetArrayLength</span><span class="p">(</span><span class="o">*</span><span class="n">fArray</span><span class="p">);</span>
 
   <span class="c1">// Get the elements
</span>   <span class="kt">float</span><span class="o">*</span> <span class="n">data</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetFloatArrayElements</span><span class="p">(</span><span class="o">*</span><span class="n">fArray</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
 
   <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">len</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
   <span class="p">{</span>
        <span class="n">result</span> <span class="o">+=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
   <span class="p">}</span>
 
   <span class="c1">// Don't forget to release it
</span>   <span class="n">env</span><span class="o">-&gt;</span><span class="n">ReleaseFloatArrayElements</span><span class="p">(</span><span class="o">*</span><span class="n">fArray</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
 
   <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
</div>

<h5 id="네이티브-함수를-통해-값을-반환합니다">네이티브 함수를 통해 값을 반환합니다.</h5>

<div class="language-cpp highlighter-rouge"><pre class="highlight"><code><span class="n">JNIEXPORT</span>
<span class="n">jint</span>
<span class="n">JNICALL</span>     
<span class="nf">Java_com_autodesk_adn_jnitester_MainActivity_invokeMemberFuncFromNative</span>
<span class="p">(</span>
	<span class="n">JNIEnv</span> <span class="o">*</span><span class="n">env</span><span class="p">,</span>
	<span class="n">jobject</span> <span class="n">callingObject</span><span class="p">,</span>
	<span class="n">jobject</span> <span class="n">obj</span>
<span class="p">)</span>
<span class="p">{</span>
	<span class="n">jclass</span> <span class="n">cls</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetObjectClass</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
	<span class="n">jmethodID</span> <span class="n">methodId</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetMethodID</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="s">"getFacetCount"</span><span class="p">,</span> <span class="s">"()I"</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">CallIntMethod</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">methodId</span><span class="p">);</span>
	    
	<span class="c1">//Return the facet count (an int)  
</span>	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
</div>

<h5 id="네이티브-코드에서-자바-객체-인스턴스-만들기">네이티브 코드에서 자바 객체 인스턴스 만들기</h5>

<div class="language-cpp highlighter-rouge"><pre class="highlight"><code><span class="n">JNIEXPORT</span>
<span class="n">jobject</span>
<span class="n">JNICALL</span>
<span class="nf">Java_com_autodesk_adn_jnitester_MainActivity_createObjectFromNative</span>
<span class="p">(</span>
	<span class="n">JNIEnv</span> <span class="o">*</span><span class="n">env</span><span class="p">,</span>
	<span class="n">jobject</span> <span class="n">callingObject</span><span class="p">,</span>
	<span class="n">jint</span> <span class="n">param</span>
<span class="p">)</span>
<span class="p">{</span>
	<span class="n">jclass</span> <span class="n">cls</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">FindClass</span><span class="p">(</span><span class="s">"com/autodesk/adn/jnitester/MeshData"</span><span class="p">);</span>
	<span class="n">jmethodID</span> <span class="n">methodId</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetMethodID</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="s">"&lt;init&gt;"</span><span class="p">,</span> <span class="s">"(I)V"</span><span class="p">);</span>
	<span class="n">jobject</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">NewObject</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">methodId</span><span class="p">,</span> <span class="n">param</span><span class="p">);</span>
 
	<span class="k">return</span> <span class="n">obj</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
</div>

<h4 id="3-자바와-네이티브-코드-간에-객체의-배열-전달하기">3. 자바와 네이티브 코드 간에 객체의 배열 전달하기</h4>

<h5 id="객체-배열을-네이티브-코드로-전달하는-자바-메서드를-만듭니다">객체 배열을 네이티브 코드로 전달하는 자바 메서드를 만듭니다.</h5>

<p>List 또는 객체들을 네이티브 코드에 전달할 수 없습니다. 배열로 전달해야 합니다.</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">native</span> <span class="kt">int</span> <span class="nf">processObjectArrayFromNative</span><span class="o">(</span><span class="n">MeshData</span><span class="o">[]</span> <span class="n">objArray</span><span class="o">);</span>
</code></pre>
</div>

<h5 id="네이티브-코드에서-자바-객체-배열jobjectarray-읽기">네이티브 코드에서 자바 객체 배열(jobjectArray) 읽기</h5>

<div class="language-cpp highlighter-rouge"><pre class="highlight"><code><span class="n">JNIEXPORT</span>
<span class="n">jint</span>
<span class="n">JNICALL</span>
<span class="nf">Java_com_autodesk_adn_jnitester_MainActivity_processObjectArrayFromNative</span>
<span class="p">(</span>
	<span class="n">JNIEnv</span> <span class="o">*</span><span class="n">env</span><span class="p">,</span>
	<span class="n">jobject</span> <span class="n">callingObject</span><span class="p">,</span>
	<span class="n">jobjectArray</span> <span class="n">objArray</span>
<span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">resultSum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	 
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetArrayLength</span><span class="p">(</span><span class="n">objArray</span><span class="p">);</span>
	 
	<span class="c1">//Get all the objects in the array
</span>	<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">len</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
	<span class="p">{</span>
	    <span class="n">jobject</span> <span class="n">obj</span> <span class="o">=</span> <span class="p">(</span><span class="n">jobject</span><span class="p">)</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetObjectArrayElement</span><span class="p">(</span><span class="n">objArray</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	 
	    <span class="n">resultSum</span> <span class="o">+=</span> <span class="n">getFacetCount</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">obj</span><span class="p">);</span>
	<span class="p">}</span>
	 
	<span class="k">return</span> <span class="n">resultSum</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
</div>

<h5 id="네이티브-코드에서-객체-배열-반환하기">네이티브 코드에서 객체 배열 반환하기</h5>

<div class="language-cpp highlighter-rouge"><pre class="highlight"><code><span class="n">JNIEXPORT</span> 
<span class="n">jobjectArray</span> 
<span class="n">JNICALL</span> 
<span class="nf">Java_ProcessInformation_getAllProcessPid</span>
<span class="p">(</span>
	<span class="n">JNIEnv</span><span class="o">*</span><span class="n">env</span><span class="p">,</span>
	<span class="n">jobject</span> <span class="n">obj</span>
<span class="p">)</span>
<span class="p">{</span>
	<span class="c1">//Create a vector (an array) of Strings and add items to it
</span>   <span class="n">vector</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span><span class="n">vec</span><span class="p">;</span>
	<span class="n">vec</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="s">"Ranjan.B.M"</span><span class="p">);</span>
	<span class="n">vec</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="s">"Mithun.V"</span><span class="p">);</span>
	<span class="n">vec</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="s">"Preetham.S.N"</span><span class="p">);</span>
	<span class="n">vec</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="s">"Karthik.S.G"</span><span class="p">);</span>
	<span class="n">cout</span><span class="o">&lt;&lt;</span> <span class="n">vec</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="c1">//Instantiate your object Array and return it!
</span>	<span class="n">jclass</span> <span class="n">clazz</span> <span class="o">=</span> <span class="p">(</span><span class="n">env</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">FindClass</span><span class="p">(</span><span class="s">"java/lang/String"</span><span class="p">);</span>
	<span class="n">jobjectArray</span> <span class="n">objarray</span> <span class="o">=</span> <span class="p">(</span><span class="n">env</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">NewObjectArray</span><span class="p">(</span><span class="n">vec</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="p">,</span><span class="n">clazz</span> <span class="p">,</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">vec</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">string</span> <span class="n">s</span> <span class="o">=</span> <span class="n">vec</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">cout</span><span class="o">&lt;&lt;</span> <span class="n">vec</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;&lt;</span><span class="n">endl</span><span class="p">;</span>
		<span class="n">jstring</span> <span class="n">js</span> <span class="o">=</span> <span class="p">(</span><span class="n">env</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">NewStringUTF</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
		<span class="p">(</span><span class="n">env</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">SetObjectArrayElement</span><span class="p">(</span><span class="n">objarray</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">js</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">objarray</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
</div>

<h2 id="참고자료">참고자료</h2>
<ul>
  <li><a href="http://adndevblog.typepad.com/cloud_and_mobile/2013/08/android-ndk-passing-complex-data-to-jni.html">Android NDK: Passing complex data between Java and JNI methods</a></li>
  <li><a href="https://stackoverflow.com/questions/10813346/pass-return-and-convert-to-vectors-list-of-lists-over-jni">Pass, return and convert to vectors list of lists over JNI</a></li>
  <li><a href="https://www.developer.com/java/data/manipulating-java-objects-in-native-code.html">Manipulating Java Objects in Native Code</a></li>
  <li><a href="https://developer.android.com/training/articles/perf-jni.html">JNI Tips</a></li>
  <li><a href="https://developer.android.com/studio/projects/add-native-code.html">Add C and C++ Code to Your Project</a></li>
  <li><a href="https://github.com/googlesamples/android-ndk">googlesamples/android-ndk</a></li>
</ul>


		<div style='padding:20px 0; height: 40px'>
    
    	<div style='float:left'>
        <a class="equalize" href="/digital-video-tech" title="Previous Post: 디지털 비디오 기술 이해하기">
                <b> ← 디지털 비디오 기술 이해하기 </b>
        </a>
		</div>
    
    <div style='float:right'>
        <a class="equalize" href="/sgl-story/" title="next Post: SGL:소프트웨어 3D 렌러러 이야기">
                <b> SGL:소프트웨어 3D 렌러러 이야기 → </b>
        </a>
    </div>
</div>    
		
      </section>
    </div>
    <footer>
     <p></a></p>
     <p>Theme by <a href="https://github.com/orderedlist">orderedlist</a></p>
    </footer>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->

    
  </body>
</html>
