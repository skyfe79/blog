<p>Xcode 플레이그라운에서 실시간으로 카메라 피드를 보여줄 수 있을까? iOS용 플레이그라운에서는 불가능하지만 MacOS용 플레이그라운드에서는 가능하다. iOS용 플레이그라운드는 플레이그라운드를 실행할 때 시뮬레이터를 사용한다. 그러나 iOS용 시뮬레이터는 현재까지 실시간 카메라피드를 지원하지 않는다. MacOS환경에서 카메라피드를 실시간으로 플레이그라운드에 보여주는 예제를 작성해 보자.</p>

<h3 id="macos-플레이그라운드를-만든다">MacOS 플레이그라운드를 만든다.</h3>

<p><img src="/assets/images/show-camera-feed-on-playground/img01.png" alt="" class="fit-width" /></p>

<h3 id="캡쳐세션구성하기">캡쳐세션구성하기</h3>

<p>실시간 카메라피드를 만들기 위해서 AVFoundation 캡쳐 세션을 구성해야 한다. 캡쳐세션을 구성하는 단계는 아래와 같다.</p>

<p><img src="/assets/images/show-camera-feed-on-playground/captureOverview_2x.png" alt="" class="fit-width" />
<a href="https://developer.apple.com/library/content/documentation/AudioVideo/Conceptual/AVFoundationPG/Articles/04_MediaCapture.html#//apple_ref/doc/uid/TP40010188-CH5-SW2">이미지출처</a></p>

<ol>
  <li>세션을 생성한다.</li>
  <li>캡쳐입력을 생성한다.</li>
  <li>캡쳐출력을 생성한다.</li>
  <li>캡쳐출력 프리뷰를 설정한다.(선택사항)</li>
</ol>

<p>이 단계를 따라 코드를 작성해 보자.</p>

<p>우선 필요한 프레임워크를 임포트한다.</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="kd">import</span> <span class="kt">Cocoa</span>
<span class="kd">import</span> <span class="kt">AVFoundation</span>
<span class="kd">import</span> <span class="kt">PlaygroundSupport</span>
</code></pre>
</div>

<h4 id="캡쳐세션-만들기">캡쳐세션 만들기</h4>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="k">let</span> <span class="nv">session</span> <span class="o">=</span> <span class="kt">AVCaptureSession</span><span class="p">()</span>
<span class="n">session</span><span class="o">.</span><span class="nf">beginConfiguration</span><span class="p">()</span>
<span class="n">session</span><span class="o">.</span><span class="n">sessionPreset</span> <span class="o">=</span> <span class="kt">AVCaptureSessionPreset640x480</span>
<span class="n">session</span><span class="o">.</span><span class="nf">commitConfiguration</span><span class="p">()</span>
</code></pre>
</div>

<p>캡쳐세션 구성을 설정할 때는 반드시 <code class="highlighter-rouge">beginConfiguration</code>과 <code class="highlighter-rouge">commitConfiguration</code> 블럭 내에서 설정해야 한다.</p>

<h4 id="캡쳐입력-만들기">캡쳐입력 만들기</h4>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="k">var</span> <span class="nv">input</span> <span class="p">:</span> <span class="kt">AVCaptureDeviceInput</span>

<span class="c1">// 원하는 디바이스 찾기</span>
<span class="k">if</span> <span class="k">let</span> <span class="nv">devices</span> <span class="o">=</span> <span class="kt">AVCaptureDevice</span><span class="o">.</span><span class="nf">devices</span><span class="p">()</span> <span class="k">as?</span> <span class="p">[</span><span class="kt">AVCaptureDevice</span><span class="p">]</span> <span class="p">{</span>
    <span class="k">for</span> <span class="n">device</span> <span class="k">in</span> <span class="n">devices</span> <span class="p">{</span>
        <span class="k">if</span> <span class="n">device</span><span class="o">.</span><span class="nf">hasMediaType</span><span class="p">(</span><span class="kt">AVMediaTypeVideo</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">device</span><span class="o">.</span><span class="nf">supportsAVCaptureSessionPreset</span><span class="p">(</span><span class="kt">AVCaptureSessionPreset640x480</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">do</span> <span class="p">{</span>
                <span class="n">input</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">AVCaptureDeviceInput</span><span class="p">(</span><span class="nv">device</span><span class="p">:</span> <span class="n">device</span><span class="p">)</span>
                <span class="c1">// 찾은 디바이스를 세션에 추가한다.</span>
                <span class="k">if</span> <span class="n">session</span><span class="o">.</span><span class="nf">canAddInput</span><span class="p">(</span><span class="n">input</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">session</span><span class="o">.</span><span class="nf">addInput</span><span class="p">(</span><span class="n">input</span><span class="p">)</span>
                    <span class="k">break</span>
                <span class="p">}</span>
            <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
                <span class="nf">print</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>캡쳐입력을 만들 때는 원하는 기능을 갖춘 디바이스를 찾아서 캡쳐입력을 만들어야 한다. 만든 캡쳐입력을 만든 다음에는 세션에 추가한다.</p>

<h4 id="캡쳐출력-만들기">캡쳐출력 만들기</h4>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="k">let</span> <span class="nv">output</span> <span class="o">=</span> <span class="kt">AVCaptureVideoDataOutput</span><span class="p">()</span>
<span class="n">output</span><span class="o">.</span><span class="n">videoSettings</span> <span class="o">=</span> <span class="p">[</span><span class="n">kCVPixelBufferPixelFormatTypeKey</span> <span class="k">as</span> <span class="kt">AnyHashable</span> <span class="p">:</span> <span class="n">kCVPixelFormatType_32BGRA</span><span class="p">]</span>
<span class="n">output</span><span class="o">.</span><span class="n">alwaysDiscardsLateVideoFrames</span> <span class="o">=</span> <span class="kc">true</span>

<span class="k">if</span> <span class="n">session</span><span class="o">.</span><span class="nf">canAddOutput</span><span class="p">(</span><span class="n">output</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">session</span><span class="o">.</span><span class="nf">addOutput</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>
</div>

<p>출력할 비디오 프레임의 픽셀 포맷을 설정한다. 지연된 프레임은 버리도록 설정한다.</p>

<h4 id="프리뷰-레이어-만들기">프리뷰 레이어 만들기</h4>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="k">let</span> <span class="nv">captureLayer</span> <span class="o">=</span> <span class="kt">AVCaptureVideoPreviewLayer</span><span class="p">(</span><span class="nv">session</span><span class="p">:</span> <span class="n">session</span><span class="p">)</span>

<span class="k">let</span> <span class="nv">view</span> <span class="o">=</span> <span class="kt">NSView</span><span class="p">(</span><span class="nv">frame</span><span class="p">:</span> <span class="kt">NSRect</span><span class="p">(</span><span class="nv">x</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">y</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">width</span><span class="p">:</span> <span class="mi">640</span><span class="p">,</span> <span class="nv">height</span><span class="p">:</span> <span class="mi">480</span><span class="p">))</span>
<span class="n">view</span><span class="o">.</span><span class="n">wantsLayer</span> <span class="o">=</span> <span class="kc">true</span>
<span class="n">view</span><span class="o">.</span><span class="n">layer</span> <span class="o">=</span> <span class="n">captureLayer</span>
</code></pre>
</div>

<p>프리뷰 레이어를 만든 후 NSView 레이어로 설정했다.</p>

<h4 id="플레이그라운드-liveview-설정하기">플레이그라운드 liveView 설정하기</h4>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="kt">PlaygroundPage</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">liveView</span> <span class="o">=</span> <span class="n">view</span>
</code></pre>
</div>

<h4 id="세션-시작하기">세션 시작하기</h4>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="n">session</span><span class="o">.</span><span class="nf">startRunning</span><span class="p">()</span>
</code></pre>
</div>

<h3 id="결과">결과</h3>

<p><img src="/assets/images/show-camera-feed-on-playground/img02.png" alt="" class="fit-width" /></p>

<h3 id="전체-코드">전체 코드</h3>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="c1">//: Playground - noun: a place where people can play</span>

<span class="kd">import</span> <span class="kt">Cocoa</span>
<span class="kd">import</span> <span class="kt">AVFoundation</span>
<span class="kd">import</span> <span class="kt">PlaygroundSupport</span>

<span class="c1">//1. 세션 만들기</span>
<span class="c1">//-------------------------------------------------------------</span>
<span class="k">let</span> <span class="nv">session</span> <span class="o">=</span> <span class="kt">AVCaptureSession</span><span class="p">()</span>
<span class="n">session</span><span class="o">.</span><span class="nf">beginConfiguration</span><span class="p">()</span>
<span class="n">session</span><span class="o">.</span><span class="n">sessionPreset</span> <span class="o">=</span> <span class="kt">AVCaptureSessionPreset640x480</span>
<span class="n">session</span><span class="o">.</span><span class="nf">commitConfiguration</span><span class="p">()</span>

<span class="c1">//2. input 만들기</span>
<span class="c1">//-------------------------------------------------------------</span>
<span class="k">var</span> <span class="nv">input</span> <span class="p">:</span> <span class="kt">AVCaptureDeviceInput</span>

<span class="c1">//3. 원하는 디바이스 찾기</span>
<span class="k">if</span> <span class="k">let</span> <span class="nv">devices</span> <span class="o">=</span> <span class="kt">AVCaptureDevice</span><span class="o">.</span><span class="nf">devices</span><span class="p">()</span> <span class="k">as?</span> <span class="p">[</span><span class="kt">AVCaptureDevice</span><span class="p">]</span> <span class="p">{</span>
    <span class="k">for</span> <span class="n">device</span> <span class="k">in</span> <span class="n">devices</span> <span class="p">{</span>
        <span class="k">if</span> <span class="n">device</span><span class="o">.</span><span class="nf">hasMediaType</span><span class="p">(</span><span class="kt">AVMediaTypeVideo</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">device</span><span class="o">.</span><span class="nf">supportsAVCaptureSessionPreset</span><span class="p">(</span><span class="kt">AVCaptureSessionPreset640x480</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">do</span> <span class="p">{</span>
                <span class="n">input</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">AVCaptureDeviceInput</span><span class="p">(</span><span class="nv">device</span><span class="p">:</span> <span class="n">device</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">session</span><span class="o">.</span><span class="nf">canAddInput</span><span class="p">(</span><span class="n">input</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">session</span><span class="o">.</span><span class="nf">addInput</span><span class="p">(</span><span class="n">input</span><span class="p">)</span>
                    <span class="k">break</span>
                <span class="p">}</span>
            <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
                <span class="nf">print</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">//4. output 만들기</span>
<span class="c1">//-------------------------------------------------------------</span>
<span class="k">let</span> <span class="nv">output</span> <span class="o">=</span> <span class="kt">AVCaptureVideoDataOutput</span><span class="p">()</span>
<span class="n">output</span><span class="o">.</span><span class="n">videoSettings</span> <span class="o">=</span> <span class="p">[</span><span class="n">kCVPixelBufferPixelFormatTypeKey</span> <span class="k">as</span> <span class="kt">AnyHashable</span> <span class="p">:</span> <span class="n">kCVPixelFormatType_32BGRA</span><span class="p">]</span>
<span class="n">output</span><span class="o">.</span><span class="n">alwaysDiscardsLateVideoFrames</span> <span class="o">=</span> <span class="kc">true</span>

<span class="k">if</span> <span class="n">session</span><span class="o">.</span><span class="nf">canAddOutput</span><span class="p">(</span><span class="n">output</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">session</span><span class="o">.</span><span class="nf">addOutput</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">//5. 캡쳐레이어 구성하기</span>
<span class="c1">//-------------------------------------------------------------</span>
<span class="k">let</span> <span class="nv">captureLayer</span> <span class="o">=</span> <span class="kt">AVCaptureVideoPreviewLayer</span><span class="p">(</span><span class="nv">session</span><span class="p">:</span> <span class="n">session</span><span class="p">)</span>

<span class="k">let</span> <span class="nv">view</span> <span class="o">=</span> <span class="kt">NSView</span><span class="p">(</span><span class="nv">frame</span><span class="p">:</span> <span class="kt">NSRect</span><span class="p">(</span><span class="nv">x</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">y</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">width</span><span class="p">:</span> <span class="mi">640</span><span class="p">,</span> <span class="nv">height</span><span class="p">:</span> <span class="mi">480</span><span class="p">))</span>
<span class="n">view</span><span class="o">.</span><span class="n">wantsLayer</span> <span class="o">=</span> <span class="kc">true</span>
<span class="n">view</span><span class="o">.</span><span class="n">layer</span> <span class="o">=</span> <span class="n">captureLayer</span>
<span class="kt">PlaygroundPage</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">liveView</span> <span class="o">=</span> <span class="n">view</span>

<span class="c1">//6. 세션시작하기</span>
<span class="c1">//-------------------------------------------------------------</span>
<span class="n">session</span><span class="o">.</span><span class="nf">startRunning</span><span class="p">()</span>
</code></pre>
</div>
