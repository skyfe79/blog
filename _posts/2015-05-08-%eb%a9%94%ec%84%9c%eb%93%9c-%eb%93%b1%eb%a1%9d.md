---
id: 423
title: 메서드 등록
date: 2015-05-08T22:47:31+00:00
author: Burt
layout: post
guid: http://blog.burt.pe.kr/?p=423
permalink: '/%eb%a9%94%ec%84%9c%eb%93%9c-%eb%93%b1%eb%a1%9d/'
dsq_thread_id:
  - "3747512650"
categories:
  - Android
  - C++
  - Java
tags:
  - jni
---
<p class="p1">
  <span class="s1">네이티브 라이브러리를 만들기 위해서 항상 javah로 자바의 클래스 파일을 사용해 헤더 파일을 뽑아 내야 하는 것은 아니다. 네이티브 라이브러에서 자바 클래스를 조사하여 네이티브 라이브러리를 등록할 수 있다. 이 방법을 사용하면 지저분한 패키지명+함수명을 담은 헤더 파일과 함수 이름이 필요없게 된다. 코드를 좀 더 깔끔하게 유지할 수 있다.</span>
</p>

<li class="p1">
  더 편하게 읽기 : <a href="http://skyfe79.gitbooks.io/jni-tutorial/content/chapter2.html">http://skyfe79.gitbooks.io/jni-tutorial/content/chapter2.html</a>
</li>

<p class="p1">
  <span class="s1">메서드를 등록하려면 JNI_OnLoad 함수에서 JavaVM을 사용해서 등록해야 한다. 기존에 작업순서는 아래와 같았다. </span>
</p>

<ol class="ol1">
  <li class="li1">
    <span class="s2">Java파일 작성</span>
  </li>
  <li class="li1">
    <span class="s2">Java파일 컴파일</span>
  </li>
  <li class="li1">
    <span class="s2">class 파일에서 javah로 C/C++용 헤더파일 추출</span>
  </li>
  <li class="li1">
    <span class="s2">C/C++ 코드 작성</span>
  </li>
  <li class="li1">
    <span class="s2">네이티브 라이브러리 작성</span>
  </li>
  <li class="li1">
    <span class="s2">실행</span>
  </li>
</ol>

<p class="p1">
  <span class="s1">하지만 이번에는 아래의 순서대로 진행해 보겠다.</span>
</p>

<ol class="ol1">
  <li class="li1">
    <span class="s2">C/C++ 코드 작성</span>
  </li>
  <li class="li1">
    <span class="s2">네이티브 라이브러리 작성</span>
  </li>
  <li class="li1">
    <span class="s2">Java파일 작성</span>
  </li>
  <li class="li1">
    <span class="s2">실행</span>
  </li>
</ol>

<p class="p1">
  <span class="s1">우선 JNI 코드 작성은 C++을 사용한다. C언어를 사용하는가? 아니면 C++언어를 사용하는가에 따라 JNI의 함수 인자들이 달라지기 때문이다.</span>
</p>

<p class="p1">
  <span class="s1">이번 튜토리얼에서는 더하기와 곱셈을 수행하는 계산기를 만들 것이다. 우선 아래처럼 C++ 코드를 작성하자</span>
</p>

<pre class="lang:default decode:true">$ vi calculator.cpp</pre>

<pre class="lang:c++ decode:true ">#include &lt;jni.h&gt;
#include &lt;iostream&gt;

jint add
(
    JNIEnv *env,
    jobject thiz,
    jint    a,
    jint    b
)
{
    return a + b;
}

jint mul
(
    JNIEnv *env,
    jobject thiz,
    jint    a,
    jint    b
)
{
	return a * b;
}</pre>

이제 위의 두 함수를 네이티브 라이브러리로 선언한 Java클래스를 검색하여 해당 네이티브 메서드의 구현체로 등록해 보자. 모든 jni 라이브러리를 로드할 때, JNI\_OnLoad 함수가 실행된다. 따라서 JNI\_OnLoad에서 해당 작업을 수행하면 좋다. JNI_OnLoad는 모든 JNI 프로그램의 시작점이다.

<pre class="lang:c++ decode:true ">JNIEXPORT jint JNICALL JNI_OnLoad
(
	JavaVM		*pVM,
	void		*reserved
)
{
	JNIEnv *env;
	if(pVM-&gt;GetEnv(reinterpret_cast&lt;void **&gt;(&env), JNI_VERSION_1_6)) {
		return -1;
	}
	
	// 메서드 시그니쳐를 생성한다.
	JNINativeMethod nm[2];
	nm[0].name = const_cast&lt;char *&gt;("add");
	nm[0].signature = const_cast&lt;char *&gt;("(II)I");
	nm[0].fnPtr = reinterpret_cast&lt;void *&gt;(add);
	nm[1].name = const_cast&lt;char *&gt;("mul");
	nm[1].signature = const_cast&lt;char *&gt;("(II)I");
	nm[1].fnPtr = reinterpret_cast&lt;void *&gt;(mul);
	
	// 클래스를 찾고 해당 클래스에 네이티브 메서드로 등록한다.
	jclass cls = env-&gt;FindClass("Calculator");
	env-&gt;RegisterNatives(cls, nm, 2);
	return JNI_VERSION_1_6;
}</pre>

전체 코드는 아래와 같다.

<pre class="lang:c++ decode:true">#include &lt;jni.h&gt;
#include &lt;iostream&gt;

jint add
(
    JNIEnv *env,
    jobject thiz,
    jint    a,
    jint    b
)
{
    return a + b;
}

jint mul
(
    JNIEnv *env,
    jobject thiz,
    jint    a,
    jint    b
)
{
	return a * b;
}

JNIEXPORT jint JNICALL JNI_OnLoad
(
	JavaVM		*pVM,
	void			*reserved
)
{
	JNIEnv *env;
	if(pVM-&gt;GetEnv(reinterpret_cast&lt;void **&gt;(&env), JNI_VERSION_1_6)) {
		return -1;
	}
	
	JNINativeMethod nm[2];
	nm[0].name = const_cast&lt;char *&gt;("add");
	nm[0].signature = const_cast&lt;char *&gt;("(II)I");
	nm[0].fnPtr = reinterpret_cast&lt;void *&gt;(add);
	nm[1].name = const_cast&lt;char *&gt;("mul");
	nm[1].signature = const_cast&lt;char *&gt;("(II)I");
	nm[1].fnPtr = reinterpret_cast&lt;void *&gt;(mul);
	
	jclass cls = env-&gt;FindClass("Calculator");
	env-&gt;RegisterNatives(cls, nm, 2);
	return JNI_VERSION_1_6;
}</pre>

위 코드를 컴파일해서 네이티브 라이브러리를 만들자

<pre class="lang:default decode:true ">$ g++ "-I/System/Library/Frameworks/JavaVM.framework/Versions/Current/Headers/" -c calculator.cpp
$ g++ -dynamiclib -o libcalculator.jnilib calculator.o</pre>

<p class="p1">
  <span class="s1">이제 이 네이티브 라이브러리를 사용하는 Java클래스를 만들자.</span>
</p>

<pre class="lang:default decode:true ">class Calculator {

    private native int add(int a, int b);
    private native int mul(int a, int b);

    public static void main(String[] args) {
        
        Calculator calc = new Calculator();

        System.out.println("1+1 = " + calc.add(1, 1));
        System.out.println("10*10 = " + calc.mul(10, 10));    
    }
    static {
        System.loadLibrary("calculator");
    }
}</pre>

위의 Java코드를 컴파일하고 실행해 보자

<pre class="lang:default decode:true">$ javac Calculator.java
$ java Calculator
1+1 = 2
10*10 = 100</pre>

참고로 자바 타입에 대한 시그니쳐는 아래와 같다.

<p class="p1">
  <span class="s1"><b>Java VM Type Signatures</b></span>
</p>

<table class="t1" cellspacing="0" cellpadding="0">
  <tr>
    <td class="td1" valign="middle">
      <p class="p2">
        <span class="s1">Signature</span>
      </p>
    </td>
    
    <td class="td2" valign="middle">
      <p class="p2">
        <span class="s1">Java Type</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td class="td3" valign="middle">
      <p class="p2">
        <span class="s1">Z</span>
      </p>
    </td>
    
    <td class="td4" valign="middle">
      <p class="p2">
        <span class="s1">boolean</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td class="td1" valign="middle">
      <p class="p2">
        <span class="s1">B</span>
      </p>
    </td>
    
    <td class="td2" valign="middle">
      <p class="p2">
        <span class="s1">byte</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td class="td3" valign="middle">
      <p class="p2">
        <span class="s1">C</span>
      </p>
    </td>
    
    <td class="td4" valign="middle">
      <p class="p2">
        <span class="s1">char</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td class="td1" valign="middle">
      <p class="p2">
        <span class="s1">S</span>
      </p>
    </td>
    
    <td class="td2" valign="middle">
      <p class="p2">
        <span class="s1">short</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td class="td3" valign="middle">
      <p class="p2">
        <span class="s1">I</span>
      </p>
    </td>
    
    <td class="td4" valign="middle">
      <p class="p2">
        <span class="s1">int</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td class="td1" valign="middle">
      <p class="p2">
        <span class="s1">J</span>
      </p>
    </td>
    
    <td class="td2" valign="middle">
      <p class="p2">
        <span class="s1">long</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td class="td3" valign="middle">
      <p class="p2">
        <span class="s1">F</span>
      </p>
    </td>
    
    <td class="td4" valign="middle">
      <p class="p2">
        <span class="s1">float</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td class="td1" valign="middle">
      <p class="p2">
        <span class="s1">D</span>
      </p>
    </td>
    
    <td class="td2" valign="middle">
      <p class="p2">
        <span class="s1">double</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td class="td3" valign="middle">
      <p class="p2">
        <span class="s1">L fully-qualified-class ;</span>
      </p>
    </td>
    
    <td class="td4" valign="middle">
      <p class="p2">
        <span class="s1">fully-qualified-class</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td class="td1" valign="middle">
      <p class="p2">
        <span class="s1">[ type</span>
      </p>
    </td>
    
    <td class="td2" valign="middle">
      <p class="p2">
        <span class="s1">type[]</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td class="td3" valign="middle">
      <p class="p2">
        <span class="s1">( arg-types ) ret-type</span>
      </p>
    </td>
    
    <td class="td4" valign="middle">
      <p class="p2">
        <span class="s1">method type</span>
      </p>
    </td>
  </tr>
</table>

몇가지 예제

<table class="t2" cellspacing="0" cellpadding="0">
  <tr>
    <td class="td5" valign="middle">
      <p class="p3">
        <span class="s1"><b>Method</b></span>
      </p>
    </td>
    
    <td class="td6" valign="middle">
      <p class="p3">
        <span class="s1"><b>Signature</b></span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td class="td7" valign="middle">
      <p class="p4">
        <span class="s1">void f1()</span>
      </p>
    </td>
    
    <td class="td8" valign="middle">
      <p class="p4">
        <span class="s1">()V</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td class="td5" valign="middle">
      <p class="p4">
        <span class="s1">int f2(int, long)</span>
      </p>
    </td>
    
    <td class="td6" valign="middle">
      <p class="p4">
        <span class="s1">(IJ)I</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td class="td7" valign="middle">
      <p class="p4">
        <span class="s1">boolean f3(int[])</span>
      </p>
    </td>
    
    <td class="td8" valign="middle">
      <p class="p4">
        <span class="s1">([I)B</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td class="td5" valign="middle">
      <p class="p4">
        <span class="s1">double f4(String, int)</span>
      </p>
    </td>
    
    <td class="td6" valign="middle">
      <p class="p4">
        <span class="s1">(Ljava/lang/String;I)D</span>
      </p>
    </td>
  </tr>
  
  <tr>
    <td class="td7" valign="middle">
      <p class="p4">
        <span class="s1">void f5(int, String [], char)</span>
      </p>
    </td>
    
    <td class="td8" valign="middle">
      <p class="p4">
        <span class="s1">(I[Ljava/lang/String;C)V</span>
      </p>
    </td>
  </tr>
</table>